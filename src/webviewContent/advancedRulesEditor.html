<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Avanzato Regole Copilot</title>
    <style>
        :root {
            --container-padding: 20px;
            --input-padding-vertical: 6px;
            --input-padding-horizontal: 12px;
            --input-margin-vertical: 4px;
            --input-margin-horizontal: 0;
        }

        body {
            padding: 0 var(--container-padding);
            color: var(--vscode-foreground);
            font-size: var(--vscode-font-size);
            font-weight: var(--vscode-font-weight);
            font-family: var(--vscode-font-family);
            background-color: var(--vscode-editor-background);
        }

        ol,
        ul {
            padding-left: var(--container-padding);
        }

        body > *,
        form > * {
            margin-block-start: var(--input-margin-vertical);
            margin-block-end: var(--input-margin-vertical);
        }

        *:focus {
            outline-color: var(--vscode-focusBorder) !important;
        }

        a {
            color: var(--vscode-textLink-foreground);
        }

        a:hover,
        a:active {
            color: var(--vscode-textLink-activeForeground);
        }

        code {
            font-size: var(--vscode-editor-font-size);
            font-family: var(--vscode-editor-font-family);
        }

        button {
            border: none;
            padding: var(--input-padding-vertical) var(--input-padding-horizontal);
            width: auto;
            text-align: center;
            color: var(--vscode-button-foreground);
            background: var(--vscode-button-background);
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--vscode-button-hoverBackground);
        }

        button:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: 2px;
        }

        button.secondary {
            color: var(--vscode-button-secondaryForeground);
            background: var(--vscode-button-secondaryBackground);
        }

        button.secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        input:not([type='checkbox']),
        textarea {
            display: block;
            width: 100%;
            border: none;
            font-family: var(--vscode-font-family);
            padding: var(--input-padding-vertical) var(--input-padding-horizontal);
            color: var(--vscode-input-foreground);
            outline-color: var(--vscode-input-border);
            background-color: var(--vscode-input-background);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .flex-row {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rules-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .rules-section {
            border: 1px solid var(--vscode-input-border);
            border-radius: 5px;
            padding: 15px;
            background-color: var(--vscode-editor-background);
        }

        .rules-section h3 {
            margin-top: 0;
            color: var(--vscode-editor-foreground);
        }

        .rule-item {
            padding: 10px;
            margin-bottom: 6px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            background-color: var(--vscode-sideBar-background);
            cursor: grab;
            position: relative;
            transition: all 0.3s ease;
            transform-origin: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .rule-item:hover {
            background-color: var(--vscode-list-hoverBackground);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .rule-item.selected {
            background-color: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .rule-item.dragging {
            opacity: 0.7;
            cursor: grabbing;
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .rule-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        .rule-item:hover .rule-controls {
            opacity: 1;
        }

        .rule-controls button {
            padding: 3px 6px;
            margin: 0;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .rule-controls button:hover {
            transform: scale(1.1);
        }

        .stats-icon {
            cursor: pointer;
            margin-left: 8px;
            color: var(--vscode-textLink-foreground);
            transition: transform 0.2s ease;
        }

        .stats-icon:hover {
            transform: scale(1.2);
        }

        .templates-section {
            border: 1px solid var(--vscode-input-border);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .template-card {
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            padding: 10px;
            background-color: var(--vscode-sideBar-background);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .template-card:hover {
            background-color: var(--vscode-list-hoverBackground);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .template-rules {
            display: none;
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .template-rules.expanded {
            display: block;
            max-height: 1000px;
        }

        .template-rule-item {
            padding: 6px;
            margin-bottom: 4px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            background-color: var(--vscode-editor-background);
            cursor: grab;
            transition: all 0.2s ease;
        }

        .template-rule-item:hover {
            background-color: var(--vscode-list-hoverBackground);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .template-rule-item.dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .dropzone {
            min-height: 100px;
            border: 2px dashed var(--vscode-input-border);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(var(--vscode-editor-background-rgb, 30, 30, 30), 0.5);
        }

        .dropzone.drag-over {
            background-color: var(--vscode-editor-selectionBackground);
            border-color: var(--vscode-textLink-foreground);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        /* Stili per le statistiche di utilizzo */
        .stats-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 5px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .stats-panel.visible {
            display: block;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stats-close {
            background: none;
            border: none;
            color: var(--vscode-editor-foreground);
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s ease;
        }

        .stats-close:hover {
            transform: scale(1.2);
        }

        .stats-content {
            margin-bottom: 20px;
        }

        .stats-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stats-item h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .stat-row {
            display: flex;
            margin-bottom: 5px;
        }

        .stat-label {
            font-weight: bold;
            width: 150px;
            flex-shrink: 0;
        }

        .stat-value {
            flex-grow: 1;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--vscode-input-border);
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background-color: rgba(var(--vscode-sideBar-background-rgb, 40, 40, 40), 0.5);
        }

        .tab.active {
            background-color: var(--vscode-sideBar-background);
            border-color: var(--vscode-input-border);
            border-bottom-color: var(--vscode-sideBar-background);
            position: relative;
            top: 1px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Overlay/backdrop per mostrare la modalitÃ  */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .overlay.visible {
            display: block;
            opacity: 1;
        }

        /* Aggiungi animazioni */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Stili per i grafici */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
            border: 1px solid var(--vscode-input-border);
            border-radius: 5px;
            padding: 15px;
            background-color: var(--vscode-sideBar-background);
        }

        .bar-chart {
            display: flex;
            height: 100%;
            align-items: flex-end;
            justify-content: space-around;
            padding: 0 20px;
        }

        .bar {
            background-color: var(--vscode-textLink-foreground);
            width: 40px;
            margin: 0 5px;
            position: relative;
            transition: height 1s ease-out;
            border-radius: 3px 3px 0 0;
            cursor: pointer;
        }

        .bar:hover {
            background-color: var(--vscode-textLink-activeForeground);
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 12px;
            width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--vscode-editor-foreground);
            font-size: 12px;
            font-weight: bold;
        }

        .chart-legend {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .chart-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .chart-tab {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            margin-right: 5px;
            transition: all 0.2s ease;
        }

        .chart-tab.active {
            background-color: var(--vscode-textLink-foreground);
            color: white;
        }

        .language-chart {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .language-item {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            min-width: 100px;
            color: white;
            transition: transform 0.2s ease;
        }

        .language-item:hover {
            transform: scale(1.05);
        }

        .language-count {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }

        .language-name {
            font-size: 12px;
        }

        /* Animazioni per drag and drop */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* Stili per il campo di ricerca e suggerimenti */
        .search-container {
            position: relative;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
        }
        
        .search-suggestions {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 100;
            display: none;
        }
        
        .search-suggestion {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .search-suggestion:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        
        .search-suggestion .highlight {
            color: var(--vscode-textLink-foreground);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Editor Avanzato Regole Copilot</h1>

    <!-- Aggiunta di un campo di ricerca con funzionalitÃ  di auto-completamento -->
    <div class="search-container">
        <input type="text" id="rule-search" placeholder="Cerca regole..." class="search-input">
        <div id="search-suggestions" class="search-suggestions">
            <!-- I suggerimenti verranno generati dinamicamente -->
        </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="tabs">
        <div class="tab active" data-tab="editor">Editor Regole</div>
        <div class="tab" data-tab="analytics">Analisi Utilizzo</div>
    </div>

    <!-- Editor Tab -->
    <div class="tab-content active" id="editor-tab">
        <div class="flex-row">
            <button id="save-btn">Salva tutte le regole</button>
            <button id="reset-btn" class="secondary">Reimposta</button>
        </div>

        <div class="templates-section">
            <h3>Template di regole per linguaggi e framework</h3>
            <p>Trascina le regole dai template all'area delle regole personali.</p>
            <div class="templates-grid" id="templates-container">
                <!-- I template verranno caricati dinamicamente da JS -->
            </div>
        </div>

        <div class="rules-container">
            <div class="rules-section">
                <h3>Regole di Default</h3>
                <p>Seleziona le regole di default da attivare:</p>
                <div class="flex-row" style="margin-bottom:8px;">
                    <button id="select-all-default" type="button">Seleziona tutto</button>
                    <button id="deselect-all-default" type="button">Deseleziona tutto</button>
                    <button id="invert-default" type="button">Inverti selezione</button>
                </div>
                <div id="default-rules-container">
                    <!-- Le regole di default verranno caricate dinamicamente da JS -->
                </div>
            </div>

            <div class="rules-section">
                <h3>Regole della Memoria</h3>
                <p>Seleziona le regole della memoria da attivare:</p>
                <div class="flex-row" style="margin-bottom:8px;">
                    <button id="select-all-memory" type="button">Seleziona tutto</button>
                    <button id="deselect-all-memory" type="button">Deseleziona tutto</button>
                    <button id="invert-memory" type="button">Inverti selezione</button>
                </div>
                <div id="memory-rules-container">
                    <!-- Le regole della memoria verranno caricate dinamicamente da JS -->
                </div>
            </div>
        </div>

        <div class="rules-section">
            <h3>Regole Personali</h3>
            <p>Aggiungi, modifica o elimina le tue regole personali:</p>
            <button id="add-rule-btn">Aggiungi nuova regola</button>
            <div id="personal-rules-container">
                <!-- Le regole personali verranno caricate dinamicamente da JS -->
            </div>
            <h4>Area di rilascio per nuove regole</h4>
            <div id="personal-rules-dropzone" class="dropzone">
                Trascina qui le regole dai template per aggiungerle alle tue regole personali
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab">
        <h2>Analisi dell'Utilizzo delle Regole</h2>
        
        <!-- Chart Tabs -->
        <div class="chart-tabs">
            <div class="chart-tab active" data-chart="usage">Utilizzo</div>
            <div class="chart-tab" data-chart="languages">Linguaggi</div>
            <div class="chart-tab" data-chart="projects">Progetti</div>
        </div>
        
        <!-- Usage Chart -->
        <div class="chart-container" id="usage-chart-container">
            <div class="chart-title">Utilizzo delle Regole</div>
            <div class="bar-chart" id="usage-chart">
                <!-- I dati del grafico verranno caricati dinamicamente da JS -->
            </div>
        </div>
        
        <!-- Languages Chart -->
        <div class="chart-container" id="languages-chart-container" style="display: none;">
            <div class="chart-title">Distribuzione per Linguaggi</div>
            <div class="language-chart" id="languages-chart">
                <!-- I dati del grafico verranno caricati dinamicamente da JS -->
            </div>
        </div>
        
        <!-- Projects Chart -->
        <div class="chart-container" id="projects-chart-container" style="display: none;">
            <div class="chart-title">Distribuzione per Progetti</div>
            <div class="bar-chart" id="projects-chart">
                <!-- I dati del grafico verranno caricati dinamicamente da JS -->
            </div>
        </div>
        
        <div id="usage-stats-container">
            <!-- Le statistiche di utilizzo verranno caricate dinamicamente da JS -->
        </div>
    </div>

    <!-- Modal per le statistiche dettagliate di una singola regola -->
    <div class="overlay" id="stats-overlay"></div>
    <div class="stats-panel" id="rule-stats-panel">
        <div class="stats-header">
            <h3>Statistiche di Utilizzo</h3>
            <button class="stats-close">âœ•</button>
        </div>
        <div class="stats-content" id="rule-stats-content">
            <!-- Il contenuto delle statistiche verrÃ  caricato dinamicamente -->
        </div>
    </div>

    <script>
        (function() {
            // Riferimento all'API vscode
            const vscode = acquireVsCodeApi();

            // Stato dell'applicazione
            let state = {
                defaultRules: [],
                memoryRules: [],
                personalRules: [],
                selectedDefaultRules: [],
                selectedMemoryRules: [],
                templates: {},
                ruleUsageStats: {}
            };

            // Colori per i grafici dei linguaggi
            const languageColors = {
                'javascript': '#f7df1e',
                'typescript': '#007acc',
                'python': '#3776ab',
                'html': '#e34c26',
                'css': '#264de4',
                'java': '#b07219',
                'csharp': '#178600',
                'php': '#4F5D95',
                'go': '#00ADD8',
                'ruby': '#CC342D',
                'unknown': '#888888'
            };

            // Elementi DOM
            const saveButton = document.getElementById('save-btn');
            const resetButton = document.getElementById('reset-btn');
            const addRuleButton = document.getElementById('add-rule-btn');
            const defaultRulesContainer = document.getElementById('default-rules-container');
            const memoryRulesContainer = document.getElementById('memory-rules-container');
            const personalRulesContainer = document.getElementById('personal-rules-container');
            const personalRulesDropzone = document.getElementById('personal-rules-dropzone');
            const templatesContainer = document.getElementById('templates-container');
            const usageStatsContainer = document.getElementById('usage-stats-container');
            const ruleStatsPanel = document.getElementById('rule-stats-panel');
            const ruleStatsContent = document.getElementById('rule-stats-content');
            const statsOverlay = document.getElementById('stats-overlay');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const chartTabs = document.querySelectorAll('.chart-tab');
            const chartContainers = document.querySelectorAll('[id$="-chart-container"]');
            const usageChart = document.getElementById('usage-chart');
            const languagesChart = document.getElementById('languages-chart');
            const projectsChart = document.getElementById('projects-chart');
            const ruleSearchInput = document.getElementById('rule-search');
            const searchSuggestionsContainer = document.getElementById('search-suggestions');

            // Inizializza l'applicazione
            init();

            function init() {
                // Richiedi i dati iniziali
                vscode.postMessage({ type: 'initialize' });

                // Aggiungi event listeners
                saveButton.addEventListener('click', saveRules);
                resetButton.addEventListener('click', resetRules);
                addRuleButton.addEventListener('click', addPersonalRule);
                document.querySelector('.stats-close').addEventListener('click', closeStatsPanel);
                statsOverlay.addEventListener('click', closeStatsPanel);

                // Gestione delle tab principali
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // Aggiorna le classi attive per le tab
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Aggiorna le classi attive per i contenuti delle tab
                        tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                        
                        // Se siamo nella tab di analisi, aggiorna i grafici
                        if (tabId === 'analytics') {
                            renderCharts();
                        }
                    });
                });
                
                // Gestione delle tab dei grafici
                chartTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const chartId = tab.getAttribute('data-chart');
                        
                        // Aggiorna le classi attive per le tab
                        chartTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Nascondi tutti i contenitori dei grafici
                        chartContainers.forEach(container => {
                            container.style.display = 'none';
                        });
                        
                        // Mostra il contenitore del grafico selezionato
                        document.getElementById(`${chartId}-chart-container`).style.display = 'block';
                    });
                });

                // Inizializza drag and drop per la dropzone
                personalRulesDropzone.addEventListener('dragover', e => {
                    e.preventDefault();
                    personalRulesDropzone.classList.add('drag-over');
                });

                personalRulesDropzone.addEventListener('dragleave', () => {
                    personalRulesDropzone.classList.remove('drag-over');
                });

                personalRulesDropzone.addEventListener('drop', e => {
                    e.preventDefault();
                    personalRulesDropzone.classList.remove('drag-over');
                    
                    const ruleText = e.dataTransfer.getData('text/plain');
                    if (ruleText) {
                        addRuleToPersonal(ruleText);
                        // Aggiunge animazione di feedback quando una regola viene rilasciata
                        personalRulesDropzone.classList.add('pulse');
                        setTimeout(() => {
                            personalRulesDropzone.classList.remove('pulse');
                        }, 1000);
                    }
                });

                // FunzionalitÃ  di ricerca con auto-completamento
                ruleSearchInput.addEventListener('input', () => {
                    const query = ruleSearchInput.value.toLowerCase();
                    searchSuggestionsContainer.innerHTML = '';
                    if (query) {
                        const allRules = [...state.defaultRules, ...state.memoryRules, ...state.personalRules];
                        const filteredRules = allRules.filter(rule => rule.toLowerCase().includes(query));
                        filteredRules.forEach(rule => {
                            const suggestion = document.createElement('div');
                            suggestion.className = 'search-suggestion';
                            suggestion.textContent = rule;
                            suggestion.addEventListener('click', () => {
                                addRuleToPersonal(rule);
                                ruleSearchInput.value = '';
                                searchSuggestionsContainer.innerHTML = '';
                            });
                            searchSuggestionsContainer.appendChild(suggestion);
                        });
                        searchSuggestionsContainer.style.display = 'block';
                    } else {
                        searchSuggestionsContainer.style.display = 'none';
                    }
                });

                document.addEventListener('click', (event) => {
                    if (!ruleSearchInput.contains(event.target) && !searchSuggestionsContainer.contains(event.target)) {
                        searchSuggestionsContainer.style.display = 'none';
                    }
                });
            }

            // Gestisci messaggi dall'estensione
            window.addEventListener('message', event => {
                const message = event.data;
                
                switch (message.type) {
                    case 'update':
                        state = message.data;
                        renderUI();
                        break;
                }
            });

            // Rendering dell'interfaccia utente
            function renderUI() {
                renderDefaultRules();
                renderMemoryRules();
                renderPersonalRules();
                renderTemplates();
                renderUsageStats();
                
                // Renderizza i grafici solo se la tab di analisi Ã¨ attiva
                if (document.getElementById('analytics-tab').classList.contains('active')) {
                    renderCharts();
                }
            }

            // Rendering delle regole di default
            function renderDefaultRules() {
                defaultRulesContainer.innerHTML = '';
                
                state.defaultRules.forEach(rule => {
                    const isSelected = state.selectedDefaultRules.includes(rule);
                    const hasStats = state.ruleUsageStats[rule] !== undefined;
                    
                    const ruleElement = document.createElement('div');
                    ruleElement.className = `rule-item ${isSelected ? 'selected' : ''}`;
                    
                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = isSelected;
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            if (!state.selectedDefaultRules.includes(rule)) {
                                state.selectedDefaultRules.push(rule);
                            }
                        } else {
                            const index = state.selectedDefaultRules.indexOf(rule);
                            if (index !== -1) {
                                state.selectedDefaultRules.splice(index, 1);
                            }
                        }
                        ruleElement.classList.add('pulse');
                        setTimeout(() => ruleElement.classList.remove('pulse'), 500);
                    });
                    
                    // Testo della regola
                    const ruleText = document.createElement('span');
                    ruleText.textContent = rule;
                    
                    // Icona delle statistiche (se disponibili)
                    if (hasStats) {
                        const statsIcon = document.createElement('span');
                        statsIcon.className = 'stats-icon';
                        statsIcon.textContent = 'ðŸ“Š';
                        statsIcon.title = 'Visualizza statistiche di utilizzo';
                        statsIcon.addEventListener('click', () => showRuleStats(rule));
                        ruleText.appendChild(statsIcon);
                    }
                    
                    ruleElement.appendChild(checkbox);
                    ruleElement.appendChild(ruleText);
                    
                    defaultRulesContainer.appendChild(ruleElement);
                });
            }

            // Rendering delle regole della memoria
            function renderMemoryRules() {
                memoryRulesContainer.innerHTML = '';
                
                state.memoryRules.forEach(rule => {
                    const isSelected = state.selectedMemoryRules.includes(rule);
                    const hasStats = state.ruleUsageStats[rule] !== undefined;
                    
                    const ruleElement = document.createElement('div');
                    ruleElement.className = `rule-item ${isSelected ? 'selected' : ''}`;
                    
                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = isSelected;
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            if (!state.selectedMemoryRules.includes(rule)) {
                                state.selectedMemoryRules.push(rule);
                            }
                        } else {
                            const index = state.selectedMemoryRules.indexOf(rule);
                            if (index !== -1) {
                                state.selectedMemoryRules.splice(index, 1);
                            }
                        }
                        ruleElement.classList.add('pulse');
                        setTimeout(() => ruleElement.classList.remove('pulse'), 500);
                    });
                    
                    // Testo della regola
                    const ruleText = document.createElement('span');
                    ruleText.textContent = rule;
                    
                    // Icona delle statistiche (se disponibili)
                    if (hasStats) {
                        const statsIcon = document.createElement('span');
                        statsIcon.className = 'stats-icon';
                        statsIcon.textContent = 'ðŸ“Š';
                        statsIcon.title = 'Visualizza statistiche di utilizzo';
                        statsIcon.addEventListener('click', () => showRuleStats(rule));
                        ruleText.appendChild(statsIcon);
                    }
                    
                    ruleElement.appendChild(checkbox);
                    ruleElement.appendChild(ruleText);
                    
                    memoryRulesContainer.appendChild(ruleElement);
                });
            }

            // Rendering delle regole personali
            function renderPersonalRules() {
                personalRulesContainer.innerHTML = '';
                
                state.personalRules.forEach((rule, index) => {
                    const hasStats = state.ruleUsageStats[rule] !== undefined;
                    
                    const ruleElement = document.createElement('div');
                    ruleElement.className = 'rule-item';
                    ruleElement.draggable = true;
                    
                    // Eventi drag and drop
                    ruleElement.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', rule);
                        e.dataTransfer.setData('application/json', JSON.stringify({
                            type: 'personal',
                            index: index
                        }));
                        ruleElement.classList.add('dragging');
                        
                        // Notifica gli altri elementi che un elemento Ã¨ in fase di trascinamento
                        personalRulesContainer.querySelectorAll('.rule-item').forEach(item => {
                            if (item !== ruleElement) {
                                item.classList.add('potential-drop-target');
                            }
                        });
                    });
                    
                    ruleElement.addEventListener('dragend', () => {
                        ruleElement.classList.remove('dragging');
                        
                        // Rimuovi la classe da tutti gli elementi
                        personalRulesContainer.querySelectorAll('.rule-item').forEach(item => {
                            item.classList.remove('potential-drop-target');
                        });
                    });
                    
                    // Aggiungi eventi per il riordinamento
                    ruleElement.addEventListener('dragover', e => {
                        e.preventDefault();
                        ruleElement.classList.add('drag-over');
                    });
                    
                    ruleElement.addEventListener('dragleave', () => {
                        ruleElement.classList.remove('drag-over');
                    });
                    
                    ruleElement.addEventListener('drop', e => {
                        e.preventDefault();
                        ruleElement.classList.remove('drag-over');
                        
                        try {
                            const data = JSON.parse(e.dataTransfer.getData('application/json'));
                            if (data.type === 'personal') {
                                // Riordina l'elemento
                                const fromIndex = data.index;
                                const toIndex = index;
                                
                                if (fromIndex !== toIndex) {
                                    const rule = state.personalRules[fromIndex];
                                    state.personalRules.splice(fromIndex, 1);
                                    state.personalRules.splice(toIndex, 0, rule);
                                    renderPersonalRules();
                                    
                                    // Animazione di feedback
                                    setTimeout(() => {
                                        const newElement = personalRulesContainer.querySelectorAll('.rule-item')[toIndex];
                                        if (newElement) {
                                            newElement.classList.add('pulse');
                                            setTimeout(() => {
                                                newElement.classList.remove('pulse');
                                            }, 1000);
                                        }
                                    }, 50);
                                }
                            }
                        } catch (error) {
                            console.error('Errore nel parsing dei dati di drag and drop:', error);
                        }
                    });
                    
                    // Testo della regola
                    const ruleText = document.createElement('span');
                    ruleText.textContent = rule;
                    
                    // Icona delle statistiche (se disponibili)
                    if (hasStats) {
                        const statsIcon = document.createElement('span');
                        statsIcon.className = 'stats-icon';
                        statsIcon.textContent = 'ðŸ“Š';
                        statsIcon.title = 'Visualizza statistiche di utilizzo';
                        statsIcon.addEventListener('click', () => showRuleStats(rule));
                        ruleText.appendChild(statsIcon);
                    }
                    
                    // Controlli
                    const controls = document.createElement('div');
                    controls.className = 'rule-controls';
                    
                    // Pulsante modifica
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Modifica';
                    editButton.addEventListener('click', () => editPersonalRule(index));
                    
                    // Pulsante elimina
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Elimina';
                    deleteButton.addEventListener('click', () => {
                        state.personalRules.splice(index, 1);
                        renderPersonalRules();
                    });
                    
                    controls.appendChild(editButton);
                    controls.appendChild(deleteButton);
                    
                    ruleElement.appendChild(ruleText);
                    ruleElement.appendChild(controls);
                    
                    personalRulesContainer.appendChild(ruleElement);
                });
            }

            // Rendering dei template
            function renderTemplates() {
                templatesContainer.innerHTML = '';
                
                Object.entries(state.templates).forEach(([language, rules]) => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card';
                    
                    // Titolo del template
                    const templateTitle = document.createElement('h4');
                    templateTitle.textContent = language;
                    
                    // Container per le regole del template
                    const templateRules = document.createElement('div');
                    templateRules.className = 'template-rules';
                    
                    // Aggiungi le regole
                    rules.forEach(rule => {
                        const ruleItem = document.createElement('div');
                        ruleItem.className = 'template-rule-item';
                        ruleItem.textContent = rule;
                        ruleItem.draggable = true;
                        
                        // Eventi drag and drop
                        ruleItem.addEventListener('dragstart', e => {
                            e.dataTransfer.setData('text/plain', rule);
                            ruleItem.classList.add('dragging');
                        });
                        
                        ruleItem.addEventListener('dragend', () => {
                            ruleItem.classList.remove('dragging');
                        });
                        
                        templateRules.appendChild(ruleItem);
                    });
                    
                    // Evento per espandere/collassare il template
                    templateTitle.addEventListener('click', () => {
                        templateRules.classList.toggle('expanded');
                        templateCard.classList.toggle('expanded');
                        
                        // Aggiungi animazione di slide-in per le regole
                        if (templateRules.classList.contains('expanded')) {
                            templateRules.querySelectorAll('.template-rule-item').forEach((item, index) => {
                                item.style.animationDelay = `${index * 0.05}s`;
                                item.classList.add('slide-in');
                                setTimeout(() => {
                                    item.classList.remove('slide-in');
                                    item.style.animationDelay = '';
                                }, 500);
                            });
                        }
                    });
                    
                    templateCard.appendChild(templateTitle);
                    templateCard.appendChild(templateRules);
                    
                    templatesContainer.appendChild(templateCard);
                });
            }

            // Rendering delle statistiche di utilizzo
            function renderUsageStats() {
                usageStatsContainer.innerHTML = '';
                
                // Se non ci sono statistiche, mostra un messaggio
                if (Object.keys(state.ruleUsageStats).length === 0) {
                    const noStatsMessage = document.createElement('p');
                    noStatsMessage.textContent = 'Nessuna statistica di utilizzo disponibile. Le statistiche verranno generate quando le regole saranno utilizzate nei commenti del codice.';
                    usageStatsContainer.appendChild(noStatsMessage);
                    return;
                }
                
                // Ordina le regole per frequenza di utilizzo (dalla piÃ¹ usata alla meno usata)
                const sortedRules = Object.entries(state.ruleUsageStats)
                    .sort((a, b) => b[1].count - a[1].count);
                
                // Crea un elemento per ogni regola
                sortedRules.forEach(([rule, stats]) => {
                    const statsItem = document.createElement('div');
                    statsItem.className = 'stats-item';
                    
                    // Titolo con regola e conteggio
                    const statsTitle = document.createElement('h4');
                    statsTitle.textContent = `${rule} (${stats.count} utilizzi)`;
                    
                    // Data ultimo utilizzo
                    const lastUsed = document.createElement('div');
                    lastUsed.className = 'stat-row';
                    
                    const lastUsedLabel = document.createElement('span');
                    lastUsedLabel.className = 'stat-label';
                    lastUsedLabel.textContent = 'Ultimo utilizzo:';
                    
                    const lastUsedValue = document.createElement('span');
                    lastUsedValue.className = 'stat-value';
                    lastUsedValue.textContent = new Date(stats.lastUsed).toLocaleString();
                    
                    lastUsed.appendChild(lastUsedLabel);
                    lastUsed.appendChild(lastUsedValue);
                    
                    // Progetti
                    const projects = document.createElement('div');
                    projects.className = 'stat-row';
                    
                    const projectsLabel = document.createElement('span');
                    projectsLabel.className = 'stat-label';
                    projectsLabel.textContent = 'Progetti:';
                    
                    const projectsValue = document.createElement('span');
                    projectsValue.className = 'stat-value';
                    projectsValue.textContent = stats.projects.join(', ') || 'Nessuno';
                    
                    projects.appendChild(projectsLabel);
                    projects.appendChild(projectsValue);
                    
                    // Linguaggi
                    const languages = document.createElement('div');
                    languages.className = 'stat-row';
                    
                    const languagesLabel = document.createElement('span');
                    languagesLabel.className = 'stat-label';
                    languagesLabel.textContent = 'Linguaggi:';
                    
                    const languagesValue = document.createElement('span');
                    languagesValue.className = 'stat-value';
                    languagesValue.textContent = stats.languages.join(', ') || 'Nessuno';
                    
                    languages.appendChild(languagesLabel);
                    languages.appendChild(languagesValue);
                    
                    // Pulsante per visualizzare statistiche dettagliate
                    const detailsButton = document.createElement('button');
                    detailsButton.textContent = 'Dettagli';
                    detailsButton.addEventListener('click', () => showRuleStats(rule));
                    
                    statsItem.appendChild(statsTitle);
                    statsItem.appendChild(lastUsed);
                    statsItem.appendChild(projects);
                    statsItem.appendChild(languages);
                    statsItem.appendChild(detailsButton);
                    
                    usageStatsContainer.appendChild(statsItem);
                });
            }

            // Rendering dei grafici di analisi
            function renderCharts() {
                // Grafico di utilizzo
                renderUsageChart();
                
                // Grafico per linguaggi
                renderLanguagesChart();
                
                // Grafico per progetti
                renderProjectsChart();
            }

            // Render del grafico di utilizzo
            function renderUsageChart() {
                usageChart.innerHTML = '';
                
                if (Object.keys(state.ruleUsageStats).length === 0) {
                    usageChart.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;"><p>Nessun dato disponibile</p></div>';
                    return;
                }
                
                // Ottieni le 10 regole piÃ¹ utilizzate
                const topRules = Object.entries(state.ruleUsageStats)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10);
                
                // Trova il valore massimo per scalare il grafico
                const maxCount = Math.max(...topRules.map(([_, stats]) => stats.count));
                
                // Crea le barre del grafico
                topRules.forEach(([rule, stats]) => {
                    const barHeight = (stats.count / maxCount) * 100;
                    
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${barHeight}%`;
                    bar.addEventListener('click', () => showRuleStats(rule));
                    
                    // Aggiungi il valore
                    const barValue = document.createElement('div');
                    barValue.className = 'bar-value';
                    barValue.textContent = stats.count;
                    
                    // Aggiungi l'etichetta
                    const barLabel = document.createElement('div');
                    barLabel.className = 'bar-label';
                    // Abbrevia il testo della regola per l'etichetta
                    barLabel.textContent = rule.length > 15 ? rule.substring(0, 12) + '...' : rule;
                    barLabel.title = rule;
                    
                    bar.appendChild(barValue);
                    bar.appendChild(barLabel);
                    
                    // Anima la barra all'inserimento
                    bar.style.height = '0';
                    usageChart.appendChild(bar);
                    
                    // Avvia l'animazione dopo un breve ritardo
                    setTimeout(() => {
                        bar.style.height = `${barHeight}%`;
                    }, 100);
                });
            }

            // Render del grafico dei linguaggi
            function renderLanguagesChart() {
                languagesChart.innerHTML = '';
                
                if (Object.keys(state.ruleUsageStats).length === 0) {
                    languagesChart.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;"><p>Nessun dato disponibile</p></div>';
                    return;
                }
                
                // Raccolta dati per linguaggi
                const languageCounts = {};
                
                // Conteggia l'utilizzo per ogni linguaggio
                Object.values(state.ruleUsageStats).forEach(stats => {
                    stats.languages.forEach(lang => {
                        if (!languageCounts[lang]) {
                            languageCounts[lang] = 0;
                        }
                        languageCounts[lang]++;
                    });
                });
                
                // Ordina i linguaggi per utilizzo
                const sortedLanguages = Object.entries(languageCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                // Crea gli elementi del grafico
                sortedLanguages.forEach(([language, count]) => {
                    const langColor = languageColors[language.toLowerCase()] || '#888888';
                    
                    const langItem = document.createElement('div');
                    langItem.className = 'language-item slide-in';
                    langItem.style.backgroundColor = langColor;
                    
                    const langCount = document.createElement('div');
                    langCount.className = 'language-count';
                    langCount.textContent = count;
                    
                    const langName = document.createElement('div');
                    langName.className = 'language-name';
                    langName.textContent = language;
                    
                    langItem.appendChild(langCount);
                    langItem.appendChild(langName);
                    
                    languagesChart.appendChild(langItem);
                });
            }

            // Render del grafico dei progetti
            function renderProjectsChart() {
                projectsChart.innerHTML = '';
                
                if (Object.keys(state.ruleUsageStats).length === 0) {
                    projectsChart.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;"><p>Nessun dato disponibile</p></div>';
                    return;
                }
                
                // Raccolta dati per progetti
                const projectCounts = {};
                
                // Conteggia l'utilizzo per ogni progetto
                Object.values(state.ruleUsageStats).forEach(stats => {
                    stats.projects.forEach(project => {
                        if (!projectCounts[project]) {
                            projectCounts[project] = 0;
                        }
                        projectCounts[project]++;
                    });
                });
                
                // Ordina i progetti per utilizzo
                const sortedProjects = Object.entries(projectCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10); // Limita a 10 progetti
                
                // Trova il valore massimo per scalare il grafico
                const maxCount = Math.max(...sortedProjects.map(([_, count]) => count));
                
                // Crea le barre del grafico
                sortedProjects.forEach(([project, count]) => {
                    const barHeight = (count / maxCount) * 100;
                    
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${barHeight}%`;
                    bar.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 60%)`;
                    
                    // Aggiungi il valore
                    const barValue = document.createElement('div');
                    barValue.className = 'bar-value';
                    barValue.textContent = count;
                    
                    // Aggiungi l'etichetta
                    const barLabel = document.createElement('div');
                    barLabel.className = 'bar-label';
                    // Abbrevia il nome del progetto per l'etichetta
                    barLabel.textContent = project.length > 15 ? project.substring(0, 12) + '...' : project;
                    barLabel.title = project;
                    
                    bar.appendChild(barValue);
                    bar.appendChild(barLabel);
                    
                    // Anima la barra all'inserimento
                    bar.style.height = '0';
                    projectsChart.appendChild(bar);
                    
                    // Avvia l'animazione dopo un breve ritardo
                    setTimeout(() => {
                        bar.style.height = `${barHeight}%`;
                    }, 100);
                });
            }

            // Mostra statistiche dettagliate per una regola
            function showRuleStats(rule) {
                const stats = state.ruleUsageStats[rule];
                if (!stats) return;
                
                ruleStatsContent.innerHTML = '';
                
                // Titolo
                const statsTitle = document.createElement('h3');
                statsTitle.textContent = rule;
                
                // Conteggio
                const countRow = document.createElement('div');
                countRow.className = 'stat-row';
                
                const countLabel = document.createElement('span');
                countLabel.className = 'stat-label';
                countLabel.textContent = 'Utilizzi totali:';
                
                const countValue = document.createElement('span');
                countValue.className = 'stat-value';
                countValue.textContent = stats.count.toString();
                
                countRow.appendChild(countLabel);
                countRow.appendChild(countValue);
                
                // Data ultimo utilizzo
                const lastUsedRow = document.createElement('div');
                lastUsedRow.className = 'stat-row';
                
                const lastUsedLabel = document.createElement('span');
                lastUsedLabel.className = 'stat-label';
                lastUsedLabel.textContent = 'Ultimo utilizzo:';
                
                const lastUsedValue = document.createElement('span');
                lastUsedValue.className = 'stat-value';
                lastUsedValue.textContent = new Date(stats.lastUsed).toLocaleString();
                
                lastUsedRow.appendChild(lastUsedLabel);
                lastUsedRow.appendChild(lastUsedValue);
                
                // Progetti
                const projectsRow = document.createElement('div');
                projectsRow.className = 'stat-row';
                
                const projectsLabel = document.createElement('span');
                projectsLabel.className = 'stat-label';
                projectsLabel.textContent = 'Progetti:';
                
                const projectsValue = document.createElement('span');
                projectsValue.className = 'stat-value';
                projectsValue.textContent = stats.projects.join(', ') || 'Nessuno';
                
                projectsRow.appendChild(projectsLabel);
                projectsRow.appendChild(projectsValue);
                
                // Linguaggi
                const languagesRow = document.createElement('div');
                languagesRow.className = 'stat-row';
                
                const languagesLabel = document.createElement('span');
                languagesLabel.className = 'stat-label';
                languagesLabel.textContent = 'Linguaggi:';
                
                const languagesValue = document.createElement('span');
                languagesValue.className = 'stat-value';
                languagesValue.textContent = stats.languages.join(', ') || 'Nessuno';
                
                languagesRow.appendChild(languagesLabel);
                languagesRow.appendChild(languagesValue);
                
                // Aggiungi tutti gli elementi al pannello
                ruleStatsContent.appendChild(statsTitle);
                ruleStatsContent.appendChild(countRow);
                ruleStatsContent.appendChild(lastUsedRow);
                ruleStatsContent.appendChild(projectsRow);
                ruleStatsContent.appendChild(languagesRow);
                
                // Mostra il pannello
                ruleStatsPanel.classList.add('visible', 'fade-in');
                statsOverlay.classList.add('visible');
            }

            // Chiudi il pannello delle statistiche
            function closeStatsPanel() {
                ruleStatsPanel.classList.remove('visible', 'fade-in');
                statsOverlay.classList.remove('visible');
            }

            // Aggiungi una nuova regola personale
            function addPersonalRule() {
                const rule = prompt('Inserisci una nuova regola:');
                if (rule && rule.trim()) {
                    addRuleToPersonal(rule.trim());
                }
            }

            // Aggiungi una regola all'elenco delle regole personali
            function addRuleToPersonal(rule) {
                if (!state.personalRules.includes(rule)) {
                    state.personalRules.push(rule);
                    renderPersonalRules();
                    
                    // Scorre alla regola aggiunta
                    setTimeout(() => {
                        const newRuleItem = personalRulesContainer.lastElementChild;
                        if (newRuleItem) {
                            newRuleItem.scrollIntoView({ behavior: 'smooth' });
                            newRuleItem.classList.add('pulse');
                            setTimeout(() => {
                                newRuleItem.classList.remove('pulse');
                            }, 1000);
                        }
                    }, 100);
                }
            }

            // Modifica una regola personale esistente
            function editPersonalRule(index) {
                const currentRule = state.personalRules[index];
                const newRule = prompt('Modifica la regola:', currentRule);
                
                if (newRule !== null && newRule.trim()) {
                    state.personalRules[index] = newRule.trim();
                    renderPersonalRules();
                    
                    // Evidenzia la regola modificata
                    setTimeout(() => {
                        const modifiedRuleItem = personalRulesContainer.querySelectorAll('.rule-item')[index];
                        if (modifiedRuleItem) {
                            modifiedRuleItem.classList.add('pulse');
                            setTimeout(() => {
                                modifiedRuleItem.classList.remove('pulse');
                            }, 1000);
                        }
                    }, 100);
                }
            }

            // Salva tutte le regole
            function saveRules() {
                vscode.postMessage({
                    type: 'save',
                    selectedDefaultRules: state.selectedDefaultRules,
                    selectedMemoryRules: state.selectedMemoryRules,
                    personalRules: state.personalRules
                });
                
                // Animazione di feedback
                saveButton.disabled = true;
                saveButton.textContent = 'Salvato! âœ“';
                saveButton.classList.add('shake');
                
                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Salva tutte le regole';
                    saveButton.classList.remove('shake');
                }, 1500);
            }

            // Reimposta tutte le regole
            function resetRules() {
                if (confirm('Sei sicuro di voler reimpostare tutte le regole? Questa azione non puÃ² essere annullata.')) {
                    // Richiedi i dati iniziali
                    vscode.postMessage({ type: 'initialize' });
                    
                    // Animazione di feedback
                    resetButton.classList.add('shake');
                    setTimeout(() => {
                        resetButton.classList.remove('shake');
                    }, 500);
                }
            }

            function addQuickActions() {
                // Default rules
                document.getElementById('select-all-default').onclick = () => {
                    state.selectedDefaultRules = [...state.defaultRules];
                    renderDefaultRules();
                };
                document.getElementById('deselect-all-default').onclick = () => {
                    state.selectedDefaultRules = [];
                    renderDefaultRules();
                };
                document.getElementById('invert-default').onclick = () => {
                    state.selectedDefaultRules = state.defaultRules.filter(r => !state.selectedDefaultRules.includes(r));
                    renderDefaultRules();
                };
                // Memory rules
                document.getElementById('select-all-memory').onclick = () => {
                    state.selectedMemoryRules = [...state.memoryRules];
                    renderMemoryRules();
                };
                document.getElementById('deselect-all-memory').onclick = () => {
                    state.selectedMemoryRules = [];
                    renderMemoryRules();
                };
                document.getElementById('invert-memory').onclick = () => {
                    state.selectedMemoryRules = state.memoryRules.filter(r => !state.selectedMemoryRules.includes(r));
                    renderMemoryRules();
                };
            }

            // Aggiungi dopo la funzione init()
            addQuickActions();

        })();
    </script>
</body>
</html>